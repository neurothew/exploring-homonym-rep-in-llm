---
title: "analysis_homonymy"
author: "Matthew King-Hang Ma"
date: "2025-02-05"
output: html_document
---

```{r}
# For general purpose and plotting
library(Cairo)
library(tidyverse)
library(arrow)
library(ggpubr)
library(ggsci)
library(patchwork)

# For statistical analysis
# library(rstatix)
# library(emmeans)
# library(ez)
# library(xtable)
# library(lme4)
# library(lmerTest)
# library(ggstatsplot)
# library(MuMIn)

# Define your 
wd = ("~/Documents/exploring-homonym-representations-in-llm")
```
# Data preprocessing
This section prepares two dataframe `df_sim_byword` and `df_gap` from the file `df_raw_byword.feather`, which is the dataframe generated by Python scripts.

Columns:
- `cos_sim`: cosine similarity
- `angle_diff`: angular differences (computed as arccos(cos_sim))
- `angle_sim`: 90 - `angle_diff`, has the same interpretation as cosine similarity

Suffix:
`_b`: baseline
`_adj`: adjusted
```{r}
df_sim_byword = arrow::read_feather(file.path(wd, "statistics//data//df_raw_byword.feather"))
df_sim_byword$word = factor(df_sim_byword$word)
df_sim_byword$model = factor(df_sim_byword$model)
df_sim_byword$lang = factor(df_sim_byword$lang)
df_sim_byword$sense = factor(df_sim_byword$sense)
df_sim_byword$SamePOS = factor(df_sim_byword$SamePOS)
df_sim_byword$sense_type = factor(df_sim_byword$sense_type)

df_sim_byword = df_sim_byword %>% rename(POS_type = SamePOS,
                                         angle_diff_b = angle_b,
                                         angle_diff = angle)

df_sim_byword$POS_type = factor(df_sim_byword$POS_type, levels=c(0, 1), labels=c("diff", "same"))

df_sim_byword = df_sim_byword %>% select(word, model, layer, layer_rel, lang, POS_type, sense_type, sense, cos_sim, cos_sim_b, angle_diff, angle_diff_b)

df_sim_byword = df_sim_byword %>% mutate(angle_sim = 90 - df_sim_byword$angle_diff)
df_sim_byword = df_sim_byword %>% mutate(angle_sim_b = 90 - df_sim_byword$angle_diff_b)
df_sim_byword = df_sim_byword %>% mutate(angle_sim_adj = angle_sim - angle_sim_b)

```

Creating the dataframe `df_gap` storing the gap measurement.

`gap`: same-sense angular similarity - cross-sense angular similarity
```{r}
df_gap = df_sim_byword %>% select(-cos_sim, -cos_sim_b, -angle_diff_b, -angle_diff, -angle_sim, -angle_sim_b) %>% pivot_wider(names_from=c("sense_type", "sense"), values_from = "angle_sim_adj") %>% mutate("1" = same_1 - diff_0, "2" = same_2 - diff_0) %>% select(-diff_0, -same_1, -same_2) %>% pivot_longer(c("1", "2"), names_to = "sense", values_to = "gap")

df_gap$sense= factor(df_gap$sense)
```

# Example codes in plotting figures

Angular similarity gaps in English homographs by part of speech (BERT-base-uncased)
```{r}
ggboxplot(df_gap %>% filter(model=="bert-base-uncased", lang=="en"), x="layer", y="gap", color=c("POS_type"))
```

